<% content_for :header_tags do %>
  <%= javascript_include_tag 'jquery.layout-1.3.0.rc30.79-min.js', :plugin => 'redmine_re' %>
  <%= javascript_include_tag 'redmine_re.js', :plugin => 'redmine_re' %>
  <%= stylesheet_link_tag 'redmine_re.css', :plugin => "redmine_re", :media => 'all' %>
 <%= javascript_include_tag 're_artifacts_suggestible', :plugin => 'redmine_re' %>

<% end %>

<div id="infobar" class="ui-layout-west ui-layout-content">
  <%= render "requirements/treebar" %>
</div>

<div id="detail-view" class="ui-layout-center">

  <h2><%= t(:re_create_a_new) + ' ' + ( rendered_artifact_type(@artifact_type) ) %></h2>

  <%= error_messages_for @re_artifact_properties %>

    <div class="box">
    <%= form_for @re_artifact_properties, :url => { :action => :create } do |f| %>

      <%= hidden_field_tag :parent_artifact_id, @parent_artifact_id %>
      <%= hidden_field_tag :parent_relation_position, @parent_relation_position %>
      <%= f.hidden_field :artifact_type %>
      <%= f.hidden_field :project_id %>


      <%= render 'common_attributes', { :f => f } %>

      <br/>

      <fieldset class="tabular">
        <legend><%= t(:re_associated_issues) %></legend>
		       <div id="issue_filter">
		          <div class="inputs">

		  			<%= 
					select_tag 'issue_id[]', options_for_select(@re_artifact_properties.issues.collect{ |u| [u.subject, u.id] },
					@re_artifact_properties.issues.collect{ |u| u.id }), :id => 'issue_filter_input', :class => 'direct_artifacts', :multiple => true	  			
		  			%>
		            <%= text_field_tag 'issue_id[]', nil, :id => 'issue_filter_input_nojs' %>
		          </div>
		       </div>
					  <p>
	            <%= link_to image_tag('add.png')+' create related Issue', :controller=> 'issues', :action=>'new', :project_id => @project.identifier,
	              :artifacttype => @re_artifact_properties.artifact_type, :artifactname => @re_artifact_properties.name, :artifactid => @re_artifact_properties.id unless @re_artifact_properties.id.blank?%>
						</p>

      </fieldset>
     

   <fieldset>
   	<legend><%= t(:re_artifact_relationships)%></legend>

    <div class="splitcontentleft">
      <div id="relationship_link_list">
        <% @relationships_outgoing = ReArtifactRelationship.find_all_by_source_id(@re_artifact_properties.id) %>
        <% @relationships_outgoing.delete_if { |rel| rel.relation_type.eql?(ReArtifactRelationship::RELATION_TYPES[:pch]) } %>

        <% @relationships_incoming = ReArtifactRelationship.find_all_by_sink_id(@re_artifact_properties.id) %>
        <% @relationships_incoming.delete_if { |rel| rel.relation_type.eql?(ReArtifactRelationship::RELATION_TYPES[:pch]) } %>

        <%= render "re_artifact_relationship/relationship_links" %>
      </div>
      <br/>
    </div>

    <div class="splitcontentright">
		<%= javascript_tag do %>
		
		    (function($) {
		    	
		        $().ready(function() {
		       	$('#issue_filter_input option').attr("selected","selected");
		       	
	            // hidden on init because of UJS
	            $('#issue_filter_input_nojs').remove();
	            $('#issue_filter .inputs').show();

              $('#issue_filter_input').suggestible(suggestibleOptions({
                  suggestionsUrl: '<%= suggest_issues_re_queries_path(@project.id) %>',
                  suggestionsLayout: function(helpers) {
                      return new IssuesSuggestBoxItems(helpers);
                  },
                  bitsUrl: '<%= issues_bits_re_queries_path(@project.id) %>'
              }));

		      // hidden on init because of UJS
		      $('#relation_filter_input_nojs').remove();
		      $('#relation_filter .inputs').show();

              $('#relation_filter_input').suggestible(suggestibleOptions({
                  suggestionsUrl: '<%= suggest_artifacts_re_queries_path(@project.id) %>',
                  suggestionsLayout: function(helpers) {
                      return new DirectArtifactsSuggestBoxItemsForRelationsWithoutKeyEvents(helpers);
                  }
              }));
       
		        });
		        
		        
		    })(jQuery);
		
		<% end %>   	
	   	
        <b><%= t(:re_create_new_relation) %></b>
	   	<div id="relationhandling">
		   	
	           <% for relation_type in @re_relation_order %>
	               <% if ReSetting.get_serialized(relation_type, @project.id)['in_use'] && relation_type != 'parentchild' %>
					<%= radio_button :re_artifact_relationship, :relation_type, relation_type, :data => {:description => rendered_relation_type(relation_type)} %><%= rendered_relation_type(relation_type) %>	                   <br/>
	               <% end %>
	           <% end %>
		       <%= hidden_field_tag 'source[name_mode]', 'contains' %>
		       <div id="relation_filter">
		          <div class="inputs">
		             <%= select_tag 'source[name]', "<option></option>".html_safe, :id => 'relation_filter_input', :class => 'direct_artifacts' %>
		             <%= text_field_tag 'source[name]', nil, :id => 'relation_filter_input_nojs' %>
		          </div>
		       </div>
	        
	     </div>
	  </div>
   </fieldset>

    <!-- Additional fields like subtasks for task which are described in an own partial -->
    <%= render( @artifact_type.underscore+"/formfields", {:f => f} ) if File.exists?("#{Rails.root}/plugins/redmine_re/app/views/"+@artifact_type.underscore+"/_formfields.html.erb") %>

    <!-- add building blocks if user obtains the rights needed for that -->
    <div id='re_bb_section'>
      <%= render("re_building_block/bb_section", { :artifact => @re_artifact_properties, :bb_hash => @bb_hash, :bb_error_hash => @bb_error_hash } )%>
    </div>
      <%# add_bb_configuration_link(params[:controller].camelcase)%>

    <p>
    <%= submit_tag t(:re_save) %>
        &nbsp;
    <%#= link_to(t(:re_cancel), { :project_id => @project.id }, { :class => "icon icon-reload" }) %>
    </p>

  <% end %><!-- form end tag -->

  <div id="watchers">
    <%#= render :partial => 'watchers/watchers', :locals => {:watched => @re_artifact_properties} %>
  </div>
	
	<% if params.has_key? :id %>
      <div class="box">
      	<%= render "re_artifact_properties/manage_relationships", :id => params[:id], :project_id => @project.id %>
    	</div><!-- end of tab two -->
  <% end %>

	</div>

</div>
<%= javascript_tag do %>
	$j(document).ready(function(){
		$j("#re_artifact_properties_name").focus();
	});
<% end %>

