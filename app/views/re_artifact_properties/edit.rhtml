<div id='detail_view' class='detail_view'>

  <%= render 're_artifact_properties/action_menu', {:artifact => @artifact} %>

  <% if @artifact.new_record? %>
    <h2><%= t(:re_new) + ' ' + t(:re_artifact) + ' ' + t(:re_of_type) + ' ' + ( rendered_artifact_type(params[:controller]) ) %></h2>
  <% else %>
    <h2><%= t(:re_edit) + ' ' + t(:re_artifact) + ' #' + @artifact.artifact_id.to_s + ' - ' + @artifact.name + ' (' + rendered_artifact_type(params[:controller]) + ')' unless @artifact.nil? %></h2>
  <% end %>

  <%= errors_and_flash params[:controller] %>

  <ul class="tabs">
  	<li><a href="#"><%= t(:main_tab) %></a></li>
  	<!--<li><a href="#">Building blocks</a></li>-->
  	<% if params.has_key? :id %><li><a href="#"><%= t(:relations) %></a></li><% end %>
  </ul>

  <div class="panes">
  	<div class="box">
        <% form_for :artifact, :update => :detail_view, :url => {:action => "edit"}, :html => {:multipart => true } do |f| %>
	    <%= hidden_field_tag :project_id, @project.id %>
      <%= hidden_field_tag(:id, @artifact.id) unless @artifact.id.nil? %>
	    <fieldset>
	      <legend><%= t(:re_common_attributes) %></legend>

	      <div class="splitcontentleft">
	        <%= hidden_field_tag :sibling_id, @sibling.nil? ? '' : @sibling.id %>
	        <%= hidden_field_tag :parent_artifact_id, @parent.nil? ? '' : @parent.id %>

	        <p>
          <%= f.label :name, t(:re_artifact_name) %> <%= f.text_field :name, :required => true %>
	        </p>
	        <%= javascript_tag "Form.Element.focus('artifact_name');" %>
	      </div>

	      <div class="splitcontentright">
	        <p>
	          <label><%= t(:re_wiki_page_for_artifact) %></label> <%= wiki_page_of_re_artifact(@project, @artifact_properties) %>
	        </p>
	        <%
	           re_users = []
	           re_users << User.current
	           re_users.concat User.all.sort_by { |u| u.lastname }
	           re_users.delete_if { |u| !u.allowed_to? :edit_requirements, @project }
	           re_users.uniq!
	        %>
	        <p>
	          <%= f.label :responsibles, t(:re_artifact_responsible) %> <%= f.select :responsibles, re_users.collect { |u| [u.firstname+" "+ u.lastname] } %>
	        </p>
	      </div>

	    </fieldset>

	    <br/>

	    <fieldset>
	      <legend><%= t(:re_description_fieldset) %></legend>
	      <% unless @artifact.id.nil? %>
	          <div class="contextual">
	            <a href="#" accesskey="<%= accesskey(:edit) -%>" class="icon icon-edit" onclick="showAndScrollTo('update-description', 'artifact_description'); return false;"><%= l(:re_update_description) %></a>
	          </div>
	          <%= textilizable(@artifact, :description, :only_path => false) %>
	          <br/>
	      <% end %>
	      <div id='update-description' <%= 'style="display:none;"' unless @artifact.id.nil? %>>
	        <%= f.text_area :description,
	                        :cols => 60,
	                        :rows => (@artifact.description.blank? ? 10 : [[10, @artifact.description.length / 50].max, 100].min),
	                        :accesskey => accesskey(:edit),
	                        :class => 'wiki-edit' %>
	        <%= wikitoolbar_for 'artifact_description' %>
	      </div>
	    </fieldset>
	  
	    <br />
	  
	    <fieldset>
	      <legend><%= t(:re_associated_issues) %></legend>
	      <% unless @issues.nil? %>
	          
	          <%= @issues.collect { |issue|
	              (link_to issue.subject, issue_path(issue))+'&nbsp'.to_s+
	              (link_to '[X]', :controller => 're_artifact_properties', :action => 'remove_issue_from_artifact', :issueid => issue.id, :project_id=>@project.id, :id => @artifact_properties.id) }.to_sentence %>
	      <% end %>
	    </fieldset>
	    <fieldset>
	      <legend><%= t(:add_issue_to_requirement) %></legend>
	  
	  
	      <div class="splitcontentleft">
	  
	  
	  
	    <p>
	      <%= text_field_tag :issue, '', {:size => 20, :class => 'autocomplete', :id => 'issue_autocomplete'} %>
	    </p>
	  
	    <div id="issue_candidates" class="autocomplete"></div>
	    <% javascript_tag do %>
	        new Ajax.Autocompleter('issue_autocomplete',
	        'issue_candidates',
	        '<%= url_for :controller => 're_artifact_properties', :action => 'autocomplete_issue' %>',
	        {
	        paramName: 'issue_subject',
	        parameters:
	        'project_id=<%= @project.id %><%= '&id=' + @artifact_properties_id.to_s unless @artifact_properties_id.blank? %>',
	        minChars: 1,
	        frequency: 0.5,
	        afterUpdateElement : getIssueId});
	  
	        function getIssueId(text, li){
	  
	            jQuery('#added_issues').append(li.innerHTML + ', ');
	            jQuery('#added_issues').append('<input id="issue_id" type="hidden" name="issue_id[]" value=' + li.id + ' >');
	            document.getElementById('issue_autocomplete').value ="";
	        }
	  
	      <% end %>
	  
	  </div>
	  
	  <div class='splitcontentright'>
	  
	  <div id='added_issues'/>
	  </div>
  
	  <%= link_to 'create related Issue', :controller=> 'Issues', :action=>'new', :project_id => @project.id,
	      :artifacttype => @artifact.artifact_type, :artifactname => @artifact.name, :displayid => @artifact.id, :associationid => @artifact.artifact_id unless @artifact.id.blank?%>
	  </fieldset>
	  
	  <!-- Additional fields like subtasks for task which are described in an own partial --> 
	  <%= render( params[:controller]+"/formfields", {:f => f} ) if File.exists?("#{RAILS_ROOT}/vendor/plugins/redmine_re/app/views/#{params[:controller]}/_formfields.rhtml") %>

	  <!-- add building blocks if user obtains the rights needed for that -->
	  <div id='re_bb_section'>
	  	<%= add_bb_section(@artifact, @bb_hash, @bb_error_hash)%>
	  </div>
      <%# add_bb_configuration_link(params[:controller].camelcase)%>


    <% if @artifact.id %>
        <div class="rating_comments">
            <div class="rating_comments_left">
                <fieldset class="rating">
                    <legend><%= t(:rating) %></legend>

                    <div id="rating">
                        <%= render :partial => '/re_artifact_properties/rating', :locals => {:artifact => @artifact.re_artifact_properties} %>
                    </div>
                </fieldset>
            </div>
            <div class="rating_comments_right">
                <fieldset class="comment">
                    <legend> <%= t(:comments) %></legend>

                    <textarea class="comment_input" name="comment" cols="20" rows="3"></textarea>

                    <%
                    if ( User.current.preference[:others][:comments_sorting]  == "asc" )
                    	@artifact.comments.each do |comment| 
                    %>
                       <hr />
                       <p>
                          <% if User.current.allowed_to?(:administrate_requirements, @project) %>
                            [<%= link_to 'X', :controller => @artifact.artifact_type.underscore, :action => 'edit', :deletecomment_id => comment.id, :id => @artifact.id %>]
                          <% end %>

                          <b><%= comment.created_on.to_datetime.to_s[0,10] %>
                          <%= comment.created_on.to_datetime.to_s[-14,8] %> -
                          <%= User.find(comment.author_id).to_s %></b><br />
                          <%= comment.comments %></p>
                    <% end %>
                    <%
                    elsif
                    	@artifact.comments.reverse.each do |comment|
                    %>
                       <hr />
                       <p>
                          <% if User.current.allowed_to?(:administrate_requirements, @project) %>
                            [<%= link_to 'X', :controller => @artifact.artifact_type.underscore, :action => 'edit', :deletecomment_id => comment.id, :id => @artifact.id %>]
                          <% end %>

                          <b><%= comment.created_on.to_datetime.to_s[0,10] %>
                          <%= comment.created_on.to_datetime.to_s[-14,8] %> -
                          <%= User.find(comment.author_id).to_s %></b><br />
                          <%= comment.comments %></p>
                    <% end %>
                    <% end %>
                </fieldset>
            </div>
            <div class="rating_comments_clear"></div>
       </div>
    <% end %>

    <p>  
		<%= submit_tag t(:re_save) %>
			  &nbsp;
		<%= link_to(t(:re_cancel), { :project_id => @project.id }, { :class => "icon icon-reload" }) %>
	  </p>
		
	<% end %><!-- form end tag -->
	
	
  	<div id="watchers">
      <%= render :partial => 'watchers/watchers', :locals => {:watched => @artifact_properties} %>
    </div>
	
	
  	</div> <!--end of tab one -->  


  	<% if params.has_key? :id %>
	    <div class="box">
		  <%= render "re_artifact_properties/manage_relationships", :id => params[:id], :project_id => @project.id %>
		</div><!-- end of tab two -->  
	<% end %>
  </div>
</div><!-- panes-->
<% javascript_tag do %>
  jQuery(function() {
    // setup ul.tabs to work as tabs for each div directly under div.panes
    jQuery("ul.tabs").tabs("div.panes > div");
    });
<% end %>

