<% sources = @re_artifact_properties.sources %>
<% sinks   = @re_artifact_properties.sinks   %>
<% issues  = @re_artifact_properties.issues  %>

<% traces_as_source = @re_artifact_properties.traces_as_source %>
<% traces_as_sink = @re_artifact_properties.traces_as_sink %>
<% related_diagrams = @re_artifact_properties.related_diagrams %>
   
<table class="attributes">
	<colgroup>
		<col />
		<col />
		<col />
		<col style="min-width:300px width:60%" />
	</colgroup>
	<tbody>
		<tr>
			<th><%= l(:re_artifact_responsible) %></th>
			<td><%= @re_artifact_properties.responsible %></td>
			<th class="jstree-drop traces_to" data-artifactid="<%=@re_artifact_properties.id%>"> <%= t(:re_traces_to) -%></th>			
			<% current_relation = traces_as_source.shift %>
			<% s = ReArtifactProperties.find_by_id(current_relation.sink_id) if current_relation %> 
			<td class="jstree-drop traces_to" data-artifactid="<%=@re_artifact_properties.id%>"> <%= "#{rendered_relation_type(current_relation[:relation_type])} " if current_relation %> <%= t(:re_to) if s %> <%= link_to(s.name,s,{:class => "icon #{s.artifact_type.underscore}"}) if s %></td>
		</tr>
		<% traces_as_source.each do |current_relation| %>
		<tr>
			<th></th>
			<td></td>
			<th class="jstree-drop traces_to" data-artifactid="<%=@re_artifact_properties.id%>"> </th>
			<% s = ReArtifactProperties.find_by_id(current_relation.sink) %>			
			<td class="jstree-drop traces_to" data-artifactid="<%=@re_artifact_properties.id%>"> <%= "#{rendered_relation_type(current_relation[:relation_type])} " %> <%= t(:re_to) %> <%= link_to(s.name,s,{:class => "icon #{s.artifact_type.underscore}"}) %></td>
		</tr>
		<% end %>
		<tr>
			<th></th>
			<td></td>
			<th class="jstree-drop traces_from" data-artifactid="<%=@re_artifact_properties.id%>"><%= t(:re_traces_from) -%></th>			
			<% current_relation = traces_as_sink.shift %>
			<% s = nil %>			
			<% s = ReArtifactProperties.find_by_id(current_relation.source_id) if current_relation %> 
			<td class="jstree-drop traces_from" data-artifactid="<%=@re_artifact_properties.id%>"><%= "#{rendered_relation_type(current_relation[:relation_type])} " if current_relation %> <%= t(:re_from) if s %> <%= link_to(s.name,s,{:class => "icon #{s.artifact_type.underscore}"}) if s %></td>
		</tr>				
		<% traces_as_sink.each do |current_relation| %>
		<tr>
			<th></th>
			<td></td>
			<th class="jstree-drop traces_from" data-artifactid="<%=@re_artifact_properties.id%>"></th>
			<% s = ReArtifactProperties.find_by_id(current_relation.source_id)%> 
			<td class="jstree-drop traces_from" data-artifactid="<%=@re_artifact_properties.id%>"><%= "#{rendered_relation_type(current_relation[:relation_type])} " %> <%= t(:re_from) %> <%= link_to(s.name,s,{:class => "icon #{s.artifact_type.underscore}"}) %></td>
		</tr>
		<% end %>
		<tr>
			<th></th>
			<td></td>
			<th><%= t(:re_related_issues) -%></th>
			<% i = issues.first %>
			<td><%= "#{i.tracker.name} ##{i.id}" if i -%> <%= link_to(i.subject,i) if i -%></td>
			
		</tr>				
		<% issues.each_with_index do |i, index| %>
		  <% next if index==0 %>
		<tr>
			<th></th>
			<td></td>
			<th></th>
			<td><%= "#{i.tracker.name} ##{i.id}" -%> <%= link_to(i.subject,i) -%></td>
		</tr>
		<% end %>	
		
	    <% if (@project.enabled_module_names.include? 'diagrameditor') && (User.current.allowed_to?(:edit_diagrams, @project)) %>	     				
			<tr>
			<th></th>
			<td></td>
			<th><%= t(:re_diagrams) %></th>	
			<% current_diagram = related_diagrams.shift %>
					
			<td> <%= link_to(current_diagram.name, {:controller => "diagrameditor",
                      :action => 'show', :diagram_id => current_diagram.id,
                      :project_id => @project.identifier}, 
                      {:onmouseover => "display_diagram_preview(#{current_diagram.id})", 
                      :onmouseout => "$('#diagram_preview_container').hide();" }) if current_diagram %> </td>
			</tr>
			
			<% related_diagrams.each do |current_diagram| %>
				<tr>
				<th></th>
				<td></td>
				<th></th>				
				<td> <%= link_to(current_diagram.name, {:controller => "diagrameditor",
                      :action => 'show', :diagram_id => current_diagram.id,
                      :project_id => @project.identifier},
                      {:onmouseover => "display_diagram_preview(#{current_diagram.id})",
                      :onmouseout => "$('#diagram_preview_container').hide();" }) %></td>
				</tr>
			<% end %>
		<% end %>
			
	</tbody>
</table>

<script type="text/javascript">
   	function display_diagram_preview (diagram_id) {     	
  		$("#diagram_preview_image").attr('src', "/projects/<%="#{@project.identifier}"%>/diagram_preview/"+diagram_id);
  		$('#diagram_preview_container').show();
    };
</script>
	
<div id="diagram_preview_container" style="display:none;">
	<img id="diagram_preview_image" src="" style="max-width: 500px; height: auto">  
</div>

